"use client";

import { useState, Suspense } from "react";
import PaymentsList from "./PaymentsList";

export default function Home() {
  // Amount in pounds (£)
  const [amount, setAmount] = useState(1.99);
  const [loading, setLoading] = useState(false);

  const handlePay = async () => {
    setLoading(true);
    try {
      const apiUrl = process.env.NEXT_PUBLIC_API_URL;
      const pence = Math.round(amount * 100); // Convert £ to pence

      const res = await fetch(`${apiUrl}/pay?amount=${pence}`);

      if (res.redirected) {
        window.location.href = res.url;
        return;
      }

      const data = await res.json();
      if (data?.url) {
        window.location.href = data.url;
      } else {
        alert("Error: No payment URL returned.");
      }
    } catch (err) {
      console.error(err);
      alert("Payment failed.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <main className="min-h-screen p-10 text-white">

      {/* ✅ Header */}
      <header className="flex items-center justify-between mb-10 pb-6 border-b border-white/10">
        <h1 className="text-xl font-semibold tracking-tight">
          <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-emerald-400">
            EverPay
          </span>
        </h1>

        <nav className="flex gap-6 text-sm font-medium text-gray-300">
          <a href="/" className="hover:text-white transition">Dashboard</a>
          <a href="/payments" className="hover:text-white transition">Payments</a>
          <a href="/settings" className="hover:text-white transition">Settings</a>
        </nav>
      </header>

      {/* ✅ Dashboard Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-10">

        {/* ✅ Accept Payment Card */}
        <div className="bg-white/5 backdrop-blur-lg border border-white/10 rounded-2xl p-8 shadow-xl">
          <h2 className="text-2xl font-bold mb-4 text-white">Accept Payment</h2>

          <p className="text-gray-400 mb-6 text-sm">
            Enter an amount in pounds (£) to generate a Stripe Checkout link.
          </p>

          <label className="text-sm text-gray-300 mb-2 block">Amount (£)</label>
          <input
            type="number"
            step="0.01"
            min="0.01"
            value={amount}
            onChange={(e) => setAmount(parseFloat(e.target.value))}
            className="w-full px-4 py-3 mb-4 rounded-xl bg-slate-900 border border-white/10 text-white focus:outline-none focus:border-cyan-400"
          />

          <button
            onClick={handlePay}
            disabled={loading}
            className="w-full py-3 rounded-xl bg-gradient-to-r from-cyan-500 to-emerald-500 font-semibold hover:opacity-90 transition disabled:opacity-50"
          >
            {loading ? "Processing…" : `Pay £${amount.toFixed(2)}`}
          </button>

          <p className="text-xs text-gray-500 text-center mt-6 flex items-center justify-center gap-1">
            Secure payments powered by Stripe ✅
          </p>
        </div>

        {/* ✅ Recent Payments Card (LIVE) */}
        <div className="bg-white/5 backdrop-blur-lg border border-white/10 rounded-2xl p-8 shadow-xl">
          <h2 className="text-2xl font-bold mb-4 text-white">Recent Payments</h2>

          <Suspense
            fallback={
              <div className="text-gray-500 text-sm animate-pulse">
                Loading payments…
              </div>
            }
          >
            <PaymentsList />
          </Suspense>
        </div>

      </div>
    </main>
  );
}
